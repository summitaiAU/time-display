name: EAS Update (Expo)

on:
  push:
    branches: [ "main" ]

jobs:
  eas-update:
    runs-on: ubuntu-latest
    steps:
      # STEP 1: Setup environment
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Set up Node
        uses: actions/setup-node@v2
        with:
          node-version: 18

      # STEP 2: Install latest EAS CLI
      - name: Install Latest EAS CLI
        run: npm install -g eas-cli@latest

      # STEP 3: Update package.json - using a specifically tested working version combination
      - name: Update package.json for compatibility
        run: |
          npm install -g json
          
          # Use exact versions known to work together
          json -I -f package.json -e 'this.dependencies = this.dependencies || {}'
          json -I -f package.json -e 'this.dependencies.expo = "~49.0.0"'
          json -I -f package.json -e 'this.dependencies["react-native"] = "0.72.3"'
          json -I -f package.json -e 'this.dependencies.react = "18.2.0"'
          json -I -f package.json -e 'this.dependencies["expo-updates"] = "~0.18.12"'
          json -I -f package.json -e 'this.dependencies["react-native-safe-area-context"] = "4.6.3"'

      # STEP 4: Add necessary Babel configuration
      - name: Create babel.config.js
        run: |
          echo 'module.exports = function(api) {
            api.cache(true);
            return {
              presets: ["babel-preset-expo"],
              plugins: ["@babel/plugin-proposal-export-namespace-from"]
            };
          };' > babel.config.js

      # STEP 5: Install dependencies with legacy-peer-deps
      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      # STEP 6: Create eas.json
      - name: Create Compatible eas.json
        run: |
          echo '{
            "cli": {
              "version": ">=15.0.0"
            },
            "build": {
              "development": {
                "developmentClient": true,
                "distribution": "internal"
              },
              "preview": {
                "distribution": "internal"
              },
              "production": {}
            },
            "submit": {
              "production": {}
            }
          }' > eas.json

      # STEP 7: Update app.json with owner
      - name: Update app.json with owner
        run: |
          echo '{
            "expo": {
              "name": "Time Display",
              "slug": "time-display",
              "owner": "${{ secrets.EXPO_USERNAME }}",
              "sdkVersion": "49.0.0",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#000000"
              },
              "assetBundlePatterns": [
                "**/*"
              ],
              "ios": {
                "supportsTablet": true
              },
              "android": {
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#000000"
                }
              },
              "web": {
                "favicon": "./assets/favicon.png"
              },
              "runtimeVersion": {
                "policy": "sdkVersion"
              }
            }
          }' > app.json

      # STEP 8: Create assets
      - name: Create assets directory
        run: mkdir -p assets

      - name: Download assets
        run: |
          curl -s https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-blank/assets/icon.png -o assets/icon.png
          curl -s https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-blank/assets/splash.png -o assets/splash.png
          curl -s https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-blank/assets/adaptive-icon.png -o assets/adaptive-icon.png
          curl -s https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-blank/assets/favicon.png -o assets/favicon.png

      # STEP 9: Login to Expo
      - name: Expo Login
        run: CI=1 npx expo login -u ${{ secrets.EXPO_USERNAME }} -p ${{ secrets.EXPO_PASSWORD }}
        
      # STEP 10: Initialize EAS Project
      - name: Initialize EAS Project
        run: npx eas init --non-interactive --force

      # STEP 11: EAS Update
      - name: EAS Update
        run: npx eas update --branch main --message "GitHub Action update" --non-interactive
